# –ê–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ JWT —Ç–æ–∫–µ–Ω–æ–≤ –≤ SimpleBank

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

### 1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤ (`payload.go`)**
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `jwt.RegisteredClaims` –∏–∑ jwt/v5
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ UUID
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–¥–∞–Ω—ã Issuer, Subject, IssuedAt, ExpiresAt
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ username –≤ Subject (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞)

### 2. **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å Maker (`maker.go`)**
- ‚úÖ –•–æ—Ä–æ—à–∞—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- ‚úÖ –ü–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤ –±—É–¥—É—â–µ–º

### 3. **JWTMaker (`jwt_maker.go`)**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ (32 –±–∞–π—Ç–∞)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HS256 –∞–ª–≥–æ—Ä–∏—Ç–º–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç–æ–¥–∞ –ø–æ–¥–ø–∏—Å–∏

### 4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏: `ErrExpiredToken`, `ErrInvalidToken`
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `VerifyToken` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏

## ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å/–¥–æ–ø–æ–ª–Ω–∏—Ç—å:

### 1. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ jwt/v5**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í jwt/v5 —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—à–∏–±–æ–∫ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å. –ù—É–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å `jwt.ErrTokenExpired` –∏ `jwt.ValidationError`.

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–¥–µ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ —Ç–∏–ø–∞ –æ—à–∏–±–æ–∫:
```go
if errors.Is(err, jwt.ErrTokenExpired) {
    return nil, ErrExpiredToken
}
var validationErr *jwt.ValidationError
if errors.As(err, &validationErr) {
    if validationErr.Errors&jwt.ValidationErrorExpired != 0 {
        return nil, ErrExpiredToken
    }
}
```

### 2. **–ì–¥–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–∞**

–í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ **middleware** –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:

```go
// –ü—Ä–∏–º–µ—Ä –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è middleware
authRoutes := router.Group("/api/v1").Use(authMiddleware)
{
    authRoutes.POST("/accounts", server.CreateAccount)
    authRoutes.GET("/accounts/:id", server.GetAccount)
    // –∏ —Ç.–¥.
}
```

**–ó–∞—â–∏—â–µ–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (—Ç—Ä–µ–±—É—é—Ç —Ç–æ–∫–µ–Ω):**
- `/api/v1/accounts/*` - —Å–æ–∑–¥–∞–Ω–∏–µ, –ø—Ä–æ—Å–º–æ—Ç—Ä, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–æ–≤
- `/api/v1/transfers/*` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
- `/api/v1/users/*` - –ø—Ä–æ—Å–º–æ—Ç—Ä, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ü—É–±–ª–∏—á–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–Ω–µ —Ç—Ä–µ–±—É—é—Ç —Ç–æ–∫–µ–Ω):**
- `POST /api/v1/users` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `POST /api/v1/auth/login` - –ª–æ–≥–∏–Ω (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞)

### 3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ErrExpiredToken –∏ ErrInvalidToken**

–≠—Ç–∏ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤:
- **Middleware** (`internals/http/middleware/auth.go`) - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 401 —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- **Handlers** - –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

**–ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ middleware:**
```go
if err == token.ErrExpiredToken {
    ctx.JSON(http.StatusUnauthorized, gin.H{"error": "token is expired"})
    ctx.Abort()
    return
}
if err == token.ErrInvalidToken {
    ctx.JSON(http.StatusUnauthorized, gin.H{"error": "token is invalid"})
    ctx.Abort()
    return
}
```

### 4. **–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**

#### a) –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ª–æ–≥–∏–Ω–∞
–ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç `POST /api/v1/auth/login`, –∫–æ—Ç–æ—Ä—ã–π:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç username –∏ password
2. –°–æ–∑–¥–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

#### b) –î–æ–±–∞–≤–∏—Ç—å JWT —Å–µ–∫—Ä–µ—Ç –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
```yaml
# config/local.yml
jwt:
  secret_key: "your-32-character-secret-key-here!"
  access_token_duration: "15m"
```

#### c) –û–±–Ω–æ–≤–∏—Ç—å Handler –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è tokenMaker
```go
func NewHandler(log *slog.Logger, store db.Store, tokenMaker token.Maker) simplebank.Simplebank {
    return &Handler{
        handlers.NewUserHandler(log, store, tokenMaker),
        // ...
    }
}
```

#### d) –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Simplebank
–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `LoginUser`:
```go
type Simplebank interface {
    // ...
    LoginUser(ctx context.Context, in requests.LoginRequest) (*LoginResponse, error)
}
```

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

1. **–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á:**
   - ‚úÖ –ú–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞ (—É–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è)
   - ‚ö†Ô∏è –•—Ä–∞–Ω–∏—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è, –Ω–µ –≤ –∫–æ–¥–µ
   - ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è dev/prod

2. **–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞:**
   - ‚ö†Ô∏è Access token: 15 –º–∏–Ω—É—Ç (—É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) - —Ö–æ—Ä–æ—à–æ
   - üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å Refresh token –¥–ª—è –¥–æ–ª–≥–æ–∂–∏–≤—É—â–∏—Ö —Å–µ—Å—Å–∏–π

3. **–ó–∞–≥–æ–ª–æ–≤–æ–∫ Authorization:**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç `Bearer {token}`
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–ª–∏—á–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤ middleware

4. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
   - üí° –ü—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∞–∫—Ç–∏–≤–µ–Ω –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
   - üí° –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–∑—ã–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤ (blacklist)
   - üí° –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ø—ã—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤

## üß™ –¢–µ—Å—Ç—ã:

‚úÖ –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –µ—Å—Ç—å –≤ `jwt_maker_test.go`
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è expired –∏ invalid —Ç–æ–∫–µ–Ω–æ–≤ –≤ `jwt_maker_test_expired.go`

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å:
- –¢–µ—Å—Ç –¥–ª—è middleware —Å –≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
- –¢–µ—Å—Ç –¥–ª—è middleware —Å –∏—Å—Ç–µ–∫—à–∏–º —Ç–æ–∫–µ–Ω–æ–º
- –¢–µ—Å—Ç –¥–ª—è middleware —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
- –¢–µ—Å—Ç –¥–ª—è login —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞

## üìö –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞:
```go
tokenMaker, _ := token.NewJWTMaker(secretKey)
accessToken, err := tokenMaker.CreateToken(username, 15*time.Minute)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞:
```go
payload, err := tokenMaker.VerifyToken(tokenString)
if err == token.ErrExpiredToken {
    // –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫
}
if err == token.ErrInvalidToken {
    // –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ middleware:
–°–º. `internals/http/middleware/auth.go`

### –ü–æ–ª—É—á–µ–Ω–∏–µ username –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
```go
payload, exists := ctx.Get("authorization_payload")
if exists {
    tokenPayload := payload.(*token.Payload)
    username := tokenPayload.Subject
}
```

